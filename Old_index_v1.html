<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Áudio → Libras (com Hand Talk)</title>
    <link rel="stylesheet" href="estilos.css">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
</head>
<body>
  <header>
    <h1>🎙 → 🤟Voz em Libras</h1>
  </header>

  <main>
    <section class="panel">
      <h2>1) Gravação de Áudio</h2>
      <div class="controls">
        <button id="btnRec" class="btn rec">🎤 Nova Gravação</button>
        <div class="status"><span id="recDot" class="dot"></span><span id="recStatus">Aguardando…</span></div>
        <textarea id="asrOut" placeholder="O texto reconhecido aparecerá aqui…"></textarea>
        <div class="row">
          <button id="btnSendToLibras" class="btn">🤟Enviar para o Hand Talk</button>
          <button id="btnClear" class="btn" title="Limpar">🧹Limpar</button>
        </div>
        <div class="legend">Dica: fale, edite o texto se precisar e clique em <span class="kbd">Enviar para o Hand Talk</span>. Em seguida, use o botão flutuante para traduzir a fala.</div>
      </div>
    </section>

    <section class="panel">
      <h2>2) Traduzir Para Libras</h2>
      <div id="textoParaLibras" class="out" aria-live="polite">
        <h3>Traduzir a Fala</h3>
      </div>
      <p class="legend" style="margin-top:8px">A Hand Talk traduz o <em>conteúdo textual</em> da página para Libras através do avatar. Clique no ícone flutuante à direita para abrir o tradutor.</p>
    </section>
  </main>

  <footer>
    ⚠ Observação: a tradução para Libras é realizada pela **Hand Talk**. Este app apenas transcreve o áudio e escreve o texto na página para o Hand Talk traduzir. Para uso educacional — Não substitui profissional intérprete de Libras.
  </footer>

    <script>
    (function () {
        var ht = document.createElement('script');
        ht.type = 'text/javascript';
        ht.async = true;
        ht.src = 'https://plugin.handtalk.me/handtalk-plugin.js';
        var s = document.getElementsByTagName('script')[0];
        s.parentNode.insertBefore(ht, s);
    })();
</script>

  <script>
  /***********************
   * Reconhecimento de fala (Web Speech API)
   ***********************/
  const $ = sel => document.querySelector(sel);
  const btnRec = $('#btnRec');
  const btnSend = $('#btnSendToLibras');
  const btnClear = $('#btnClear');
  const asrOut = $('#asrOut');
  const recDot = $('#recDot');
  const recStatus = $('#recStatus');
  const librasOut = $('#librasOut');

  let recognition = null;
  let isRecording = false;
  let finalTranscript = '';

  function setupASR(){
    const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
    if(!SR){
      recStatus.textContent = 'Reconhecimento de fala não suportado neste navegador.';
      recDot.className = 'dot err';
      btnRec.disabled = true;
      return;
    }
    recognition = new SR();
    recognition.lang = 'pt-BR';
    recognition.continuous = true;
    recognition.interimResults = true;

    recognition.onstart = () => {
      isRecording = true;
      btnRec.classList.add('active');
      btnRec.textContent = '⏹Parar Gravação';
      recStatus.textContent = 'Ouvindo… fale normalmente.';
      recDot.className = 'dot ok';
    };
    recognition.onresult = (event) => {
      let interim = '';
      for (let i = event.resultIndex; i < event.results.length; i++) {
        const transcript = event.results[i][0].transcript;
        if (event.results[i].isFinal) finalTranscript += transcript + ' ';
        else interim += transcript;
      }
      asrOut.value = (finalTranscript + interim).trim();
    };
    recognition.onerror = (e) => {
      recStatus.textContent = 'Erro: ' + e.error;
      recDot.className = 'dot err';
    };
    recognition.onend = () => {
      isRecording = false;
      btnRec.classList.remove('active');
      btnRec.textContent = '🎤Iniciar Gravação';
      if(!asrOut.value) { recStatus.textContent = 'Aguardando…'; recDot.className = 'dot'; }
    };
  }

  setupASR();

  btnRec.addEventListener('click', () => {
    if(!recognition) return;
    if(!isRecording) recognition.start(); else recognition.stop();
  });
 
  // Função para enviar o texto para a Hand Talk
    function sendTextToHandTalk(text) {
        // Usa um timeout para garantir que o plugin Hand Talk esteja carregado
        setTimeout(() => {
            if (window.HandTalk) {
                window.HandTalk.set({
                    text: text,
                    showWidget: true
                });
            } else {
                console.error("Plugin Hand Talk não encontrado.");
            }
        }, 500); // 500ms de espera para garantir que o plugin carregue
    }

    // Envia o texto para a Hand Talk
    btnSend.addEventListener('click', () => {
        const text = (asrOut.value || '').trim();
        if (!text) {
            recStatus.textContent = 'Nenhum texto para traduzir.';
            recDot.className = 'dot warn';
            return;
        }
        
        // Coloca o texto na div que a Hand Talk irá ler
        const textToLibrasDiv = document.getElementById('textoParaLibras');
        textToLibrasDiv.innerHTML = `<h3>Traduzir a Fala</h3><p>${text}</p>`;

        sendTextToHandTalk(text);
        recStatus.textContent = 'Texto enviado. O plugin Hand Talk será exibido para tradução.';
        recDot.className = 'dot ok';
    });

  btnClear.addEventListener('click', () => { 
    asrOut.value = ''; 
    const textToLibrasDiv = document.getElementById('textoParaLibras');
    textToLibrasDiv.innerHTML = '<h3>Traduzir a Fala</h3>'; 
    finalTranscript = ''; // <-- Adicione esta linha!
});

  // Qualidade de vida
  asrOut.addEventListener('keydown', (e)=>{
    if(e.key==='Enter' && (e.ctrlKey||e.metaKey)) btnSend.click();
  });
  asrOut.placeholder = 'Ex.: "Olá, bom dia! Gostaria de saber o horário de atendimento."';
  </script>
</body>
</html>
